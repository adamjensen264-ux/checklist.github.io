<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checklist with Editable Media</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; height:100vh; background:#111; color:white; display:flex; justify-content:center; align-items:flex-start; overflow:hidden;}
#mediaCanvas { position:fixed; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events:none; }
.media-item { position:absolute; cursor:move; z-index:1; display:flex; justify-content:center; align-items:center; }
.media-item img { display:block; width:100%; height:100%; object-fit:contain; pointer-events:none; }
.media-item .deleteBtn { position:absolute; top:0; right:0; background:red; color:white; border:none; font-size:12px; padding:2px 4px; cursor:pointer; display:none; z-index:5; }
.container { background:#1c1c1ccc; padding:25px; border-radius:12px; width:380px; margin-top:30px; box-shadow:0 0 20px rgba(0,0,0,0.5); z-index:2; position:relative; }
.task { display:flex; justify-content:space-between; align-items:center; margin:8px 0; padding:5px 8px; border-radius:6px; background:#222; cursor: grab; }
.task.dragging { opacity:0.5; }
button { background:#333; border:none; color:white; padding:6px 10px; border-radius:6px; cursor:pointer; }
button:hover { background:#555; }
input[type="text"], input[type="time"] { width:70%; padding:6px; }
.controls { margin-top:10px; display:flex; gap:8px; }
.small { font-size:13px; color:#aaa; text-align:center; margin-top:10px; }
#addMediaBtn { width:60px; height:60px; border:2px dashed #fff; border-radius:8px; display:flex; justify-content:center; align-items:center; font-size:24px; cursor:pointer; color:#fff; user-select:none; position:fixed; bottom:10px; left:50%; transform:translateX(-50%); z-index:3; }
</style>
</head>
<body>

<div id="mediaCanvas"></div>

<div class="container">
<h1>Daily Checklist</h1>
<div id="taskList"></div>

<div class="controls">
    <input id="newTask" type="text" placeholder="New task...">
    <button onclick="addTask()">Add</button>
</div>

<hr>

<div>
    Reset Time:
    <input type="time" id="resetTime">
</div>

<div class="controls">
    <button onclick="manualReset()">Reset Now</button>
    <button id="editModeBtn">Enter Edit Mode</button>
</div>

<div class="small" id="info"></div>
</div>

<div id="addMediaBtn">+</div>
<input type="file" id="mediaInput" accept="image/*,image/gif" style="display:none" multiple>

<script>
/* STORAGE KEYS */
const TASK_KEY="tasks", RESET_TIME_KEY="resetTime", LAST_RESET_KEY="lastReset", MEDIA_KEY="mediaFiles";

/* TASKS */
function getTasks(){return JSON.parse(localStorage.getItem(TASK_KEY))||[];}
function saveTasks(tasks){localStorage.setItem(TASK_KEY, JSON.stringify(tasks));}

/* RENDER TASKS */
const taskListEl=document.getElementById("taskList");
let dragSrcIndex=null;
function render(){ renderTasks(); renderMedia(); updateInfo(); }

function renderTasks(){
    taskListEl.innerHTML="";
    const tasks=getTasks();
    tasks.forEach((task,index)=>{
        const div=document.createElement("div"); div.className="task"; div.draggable=true;
        const label=document.createElement("label");
        const checkbox=document.createElement("input"); checkbox.type="checkbox"; checkbox.checked=task.checked;
        checkbox.onchange=()=>{tasks[index].checked=checkbox.checked; saveTasks(tasks);}
        label.appendChild(checkbox); label.append(" "+task.text);
        const delBtn=document.createElement("button"); delBtn.textContent="✕";
        delBtn.onclick=()=>{ tasks.splice(index,1); saveTasks(tasks); render(); }
        div.appendChild(label); div.appendChild(delBtn); taskListEl.appendChild(div);

        div.addEventListener("dragstart",(e)=>{ dragSrcIndex=index; div.classList.add("dragging"); });
        div.addEventListener("dragend",()=>{ div.classList.remove("dragging"); });
        div.addEventListener("dragover",(e)=>{ e.preventDefault(); });
        div.addEventListener("drop",(e)=>{ 
            e.preventDefault();
            if(dragSrcIndex===null || dragSrcIndex===index) return;
            const moved=tasks.splice(dragSrcIndex,1)[0];
            tasks.splice(index,0,moved);
            saveTasks(tasks);
            render();
        });
    });
}

function addTask(){ const t=document.getElementById("newTask").value.trim(); if(!t) return; const tasks=getTasks(); tasks.push({text:t,checked:false}); saveTasks(tasks); document.getElementById("newTask").value=""; render(); }
function manualReset(){ const tasks=getTasks(); tasks.forEach(t=>t.checked=false); saveTasks(tasks); localStorage.setItem(LAST_RESET_KEY, Date.now()); render(); }
function getResetMinutes(){ const v=localStorage.getItem(RESET_TIME_KEY)||"04:00"; const [h,m]=v.split(":").map(Number); return h*60+m; }
function checkDailyReset(){ const last=Number(localStorage.getItem(LAST_RESET_KEY)||0); const now=new Date(); const minutesNow=now.getHours()*60+now.getMinutes(); const resetM=getResetMinutes(); const resetDate=new Date(); resetDate.setHours(0,0,0,0); resetDate.setMinutes(resetM); if(minutesNow<resetM) resetDate.setDate(resetDate.getDate()-1); if(last<resetDate.getTime()){ manualReset(); localStorage.setItem(LAST_RESET_KEY,resetDate.getTime()); } }
const resetInput=document.getElementById("resetTime");
function loadResetTime(){ resetInput.value=localStorage.getItem(RESET_TIME_KEY)||"04:00"; }
resetInput.addEventListener("change",()=>{ localStorage.setItem(RESET_TIME_KEY,resetInput.value); updateInfo(); });
function updateInfo(){ document.getElementById("info").textContent=`Checklist resets daily at ${localStorage.getItem(RESET_TIME_KEY)||"04:00"}`; }

/* MEDIA */
<script>
/* =============================
   INDEXED DB SETUP
============================= */

let db;

const request = indexedDB.open("ChecklistMediaDB", 1);

request.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore("media", { keyPath: "id", autoIncrement: true });
};

request.onsuccess = e => {
    db = e.target.result;
    renderMedia();
};

function addMediaToDB(file, callback) {
    const tx = db.transaction("media", "readwrite");
    const store = tx.objectStore("media");

    store.add({
        file: file,
        x: 50,
        y: 50,
        width: 150,
        height: 150
    });

    tx.oncomplete = callback;
}

function getAllMedia(callback) {
    const tx = db.transaction("media", "readonly");
    const store = tx.objectStore("media");
    const req = store.getAll();

    req.onsuccess = () => callback(req.result);
}

function deleteMedia(id) {
    const tx = db.transaction("media", "readwrite");
    tx.objectStore("media").delete(id);
    tx.oncomplete = renderMedia;
}

/* =============================
   ADD MEDIA
============================= */

const mediaInput = document.getElementById("mediaInput");
const addMediaBtn = document.getElementById("addMediaBtn");
const bgCanvas = document.getElementById("mediaCanvas");

addMediaBtn.onclick = () => {
    mediaInput.value = "";
    mediaInput.click();
};

mediaInput.onchange = e => {
    const files = [...e.target.files];

    let remaining = files.length;

    files.forEach(file => {
        addMediaToDB(file, () => {
            remaining--;
            if (remaining === 0) renderMedia();
        });
    });
};

/* =============================
   RENDER MEDIA
============================= */

let editMode = false;

function renderMedia() {
    if (!db) return;

    bgCanvas.innerHTML = "";

    getAllMedia(items => {
        items.forEach(item => {
            const div = document.createElement("div");
            div.className = "media-item";
            div.style.left = item.x + "px";
            div.style.top = item.y + "px";
            div.style.width = item.width + "px";
            div.style.height = item.height + "px";

            const img = document.createElement("img");
            img.src = URL.createObjectURL(item.file);
            div.appendChild(img);

            const del = document.createElement("button");
            del.textContent = "✕";
            del.className = "deleteBtn";
            del.onclick = () => deleteMedia(item.id);

            if (editMode) del.style.display = "block";

            div.appendChild(del);
            bgCanvas.appendChild(div);
        });
    });
}

/* =============================
   EDIT MODE
============================= */

document.getElementById("editModeBtn").onclick = () => {
    editMode = !editMode;
    renderMedia();
};
</script>
