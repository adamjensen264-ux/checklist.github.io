<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Daily Checklist with History</title>
<style>
body {
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#111;
  color:white;
  text-align:center;
}

.container {
  max-width:700px;
  margin:40px auto;
  background:#1e1e1e;
  padding:20px;
  border-radius:10px;
}

ul { list-style:none; padding:0; }

li {
  background:#2a2a2a;
  margin:6px 0;
  padding:8px;
  border-radius:6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:grab;
}

button {
  padding:6px 10px;
  margin:4px;
  border:none;
  border-radius:6px;
  background:#6b5cff;
  color:white;
  cursor:pointer;
}

input[type=text], input[type=date], input[type=time] {
  padding:6px;
}
</style>
</head>
<body>

<div class="container">
<h2>Daily Checklist with History</h2>

<label>Select Date:</label>
<input type="date" id="datePicker"><br><br>

<input type="text" id="taskInput" placeholder="New custom task">
<button id="addTask">Add Task</button>

<ul id="taskList"></ul>

<br>
<label>Daily Reset Time:</label>
<input type="time" id="resetTime">
<button id="manualReset">Manual Reset</button>
</div>

<script>
/* ===== STORAGE HELPERS ===== */
const load = (key, def) => JSON.parse(localStorage.getItem(key) || JSON.stringify(def));
const save = (key, val) => localStorage.setItem(key, JSON.stringify(val));

/* ===== INITIAL DATA ===== */
const baseDailyTasks = [
  {text:"Wake up early", done:false},
  {text:"Workout", done:false},
  {text:"Breakfast", done:false},
  {text:"Work/Study", done:false},
  {text:"Dinner", done:false}
];

let selectedDate = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
document.getElementById("datePicker").value = selectedDate;

function getHistory(){
  return load("checklistHistory", {});
}

function saveHistory(history){
  save("checklistHistory", history);
}

function ensureDateExists(date){
  const history = getHistory();
  if(!history[date]){
    history[date] = {
      dailyTasks: baseDailyTasks.map(t=>({...t})), 
      customTasks: []
    };
    saveHistory(history);
  }
}

/* ===== TASK RENDERING ===== */
const taskList = document.getElementById("taskList");
let draggedTaskIndex = null;

function renderTasks(){
  ensureDateExists(selectedDate);
  const history = getHistory();
  const daily = history[selectedDate].dailyTasks;
  const custom = history[selectedDate].customTasks;
  const tasks = [...daily, ...custom];

  taskList.innerHTML = "";
  tasks.forEach((t,i)=>{
    const li = document.createElement("li");
    li.draggable = true;
    li.dataset.index = i;
    li.innerHTML = `
      <span><input type="checkbox" ${t.done?"checked":""}> ${t.text}</span>
      <button>X</button>
    `;

    li.querySelector("input").onchange = e=>{
      const history = getHistory();
      const targetArray = i < daily.length ? history[selectedDate].dailyTasks : history[selectedDate].customTasks;
      const idx = i < daily.length ? i : i - daily.length;
      targetArray[idx].done = e.target.checked;
      saveHistory(history);
    };

    li.querySelector("button").onclick = ()=>{
      const history = getHistory();
      if(i < daily.length){
        history[selectedDate].dailyTasks.splice(i,1);
      } else {
        history[selectedDate].customTasks.splice(i-daily.length,1);
      }
      saveHistory(history);
      renderTasks();
    };

    // Drag & Drop reordering within current date
    li.addEventListener("dragstart",()=>{ draggedTaskIndex=i; });
    li.addEventListener("dragover",e=>e.preventDefault());
    li.addEventListener("drop",()=>{
      const history = getHistory();
      const targetArray = i < daily.length ? history[selectedDate].dailyTasks : history[selectedDate].customTasks;
      const sourceArray = draggedTaskIndex < daily.length ? history[selectedDate].dailyTasks : history[selectedDate].customTasks;
      const sourceIdx = draggedTaskIndex < daily.length ? draggedTaskIndex : draggedTaskIndex - daily.length;
      const targetIdx = i < daily.length ? i : i - daily.length;
      const [moved] = sourceArray.splice(sourceIdx,1);
      targetArray.splice(targetIdx,0,moved);
      saveHistory(history);
      renderTasks();
    });

    taskList.appendChild(li);
  });
}

/* ===== ADD CUSTOM TASK ===== */
document.getElementById("addTask").onclick = ()=>{
  const input = document.getElementById("taskInput");
  if(!input.value.trim()) return;
  ensureDateExists(selectedDate);
  const history = getHistory();
  history[selectedDate].customTasks.push({text: input.value, done:false});
  saveHistory(history);
  input.value="";
  renderTasks();
};

/* ===== DATE PICKER ===== */
document.getElementById("datePicker").onchange = e=>{
  selectedDate = e.target.value;
  ensureDateExists(selectedDate);
  renderTasks();
};

/* ===== RESET SYSTEM ===== */
const resetInput = document.getElementById("resetTime");
resetInput.value = localStorage.getItem("resetTime") || "04:00";
resetInput.onchange = ()=> localStorage.setItem("resetTime", resetInput.value);

document.getElementById("manualReset").onclick = ()=>{
  ensureDateExists(selectedDate);
  const history = getHistory();
  history[selectedDate].dailyTasks.forEach(t=>t.done=false);
  saveHistory(history);
  renderTasks();
};

function checkDailyReset(){
  const time = localStorage.getItem("resetTime");
  if(!time) return;
  const now = new Date();
  const today = now.toDateString();
  if(localStorage.getItem("lastReset") === today) return;
  const [h,m] = time.split(":");
  if(now.getHours()>=h && now.getMinutes()>=m){
    ensureDateExists(selectedDate);
    const history = getHistory();
    history[selectedDate].dailyTasks.forEach(t=>t.done=false);
    saveHistory(history);
    localStorage.setItem("lastReset",today);
    renderTasks();
  }
}
setInterval(checkDailyReset,30000);

/* ===== INIT ===== */
ensureDateExists(selectedDate);
renderTasks();
</script>
</body>
</html>
