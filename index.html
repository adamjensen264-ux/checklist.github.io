<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Checklist with Daily & Date-Specific Tasks</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; text-align:center; }
.container { max-width:800px; margin:40px auto; background:#1e1e1e; padding:20px; border-radius:10px; position:relative; z-index:2; }
ul { list-style:none; padding:0; }
li { background:#2a2a2a; margin:6px 0; padding:8px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; cursor:grab; }
button { padding:6px 10px; margin:4px; border:none; border-radius:6px; background:#6b5cff; color:white; cursor:pointer; }
input[type=text], input[type=date], input[type=time] { padding:6px; }
.editBtn { background:#ffb400; margin-left:6px; }
/* Media layer */
#mediaLayer{ position:fixed; inset:0; z-index:1; }
.media{ position:absolute; }
.media img{ width:100%; height:100%; object-fit:cover; border-radius:8px; pointer-events:none; }
.deleteBtn{ position:absolute; top:-10px; right:-10px; width:22px; height:22px; border-radius:50%; background:red; display:none; }
.resize{ width:14px; height:14px; background:white; position:absolute; right:0; bottom:0; cursor:nwse-resize; display:none; }
.edit .deleteBtn, .edit .resize{ display:block; }
</style>
</head>
<body>

<div id="mediaLayer"></div>

<div class="container">
<h2>Checklist with Media</h2>

<label>Select Date:</label>
<input type="date" id="datePicker"><br><br>

<button id="addTaskButton">Add Task</button>

<h3>Daily Tasks</h3>
<ul id="dailyList"></ul>

<h3>Custom Tasks</h3>
<ul id="customList"></ul>

<br>
<label>Daily Reset Time:</label>
<input type="time" id="resetTime">
<button id="manualReset">Manual Reset</button>
<button id="toggleEdit">Toggle Media Edit</button>
<button id="addMedia">+ Media</button>
<input type="file" id="fileInput" accept="image/*,image/gif" multiple hidden>
</div>

<script>
/* ===== STORAGE HELPERS ===== */
const load = (key, def) => JSON.parse(localStorage.getItem(key)||JSON.stringify(def));
const save = (key, val) => localStorage.setItem(key, JSON.stringify(val));

/* ===== GLOBAL DAILY TASKS ===== */
let dailyTasksGlobal = load("dailyTasksGlobal", [
  {text:"Wake up early"},
  {text:"Workout"},
  {text:"Breakfast"},
  {text:"Work/Study"},
  {text:"Dinner"}
]);

/* ===== DATE PICKER ===== */
let selectedDate = new Date().toISOString().split("T")[0];
document.getElementById("datePicker").value = selectedDate;

/* ===== HISTORY STORAGE ===== */
let checklistHistory = load("checklistHistory", {});
function getHistory(){ return checklistHistory; }
function saveHistory(){ save("checklistHistory", checklistHistory); }
function ensureDateExists(date){
  if(!checklistHistory[date]) checklistHistory[date] = {dailyTasksDone: dailyTasksGlobal.map(()=>false), customTasks: []};
}

/* ===== RENDER DAILY TASKS ===== */
const dailyList=document.getElementById("dailyList");
let draggedDailyIndex=null;
function renderDailyTasks(){
  ensureDateExists(selectedDate);
  const doneArray=checklistHistory[selectedDate].dailyTasksDone;
  dailyList.innerHTML="";
  dailyTasksGlobal.forEach((t,i)=>{
    const li=document.createElement("li");
    li.draggable=true;
    li.dataset.index=i;
    li.innerHTML=`
      <span><input type="checkbox" ${doneArray[i]?"checked":""}> ${t.text}</span>
      <button class="editBtn">✎</button>
    `;
    li.querySelector("input").onchange = e=>{
      checklistHistory[selectedDate].dailyTasksDone[i]=e.target.checked;
      saveHistory();
    };
    li.querySelector(".editBtn").onclick = ()=>{
      const newText = prompt("Edit daily task:", dailyTasksGlobal[i].text);
      if(newText!==null && newText.trim()!==""){
        dailyTasksGlobal[i].text=newText.trim();
        save("dailyTasksGlobal", dailyTasksGlobal);
        renderDailyTasks();
      }
    };
    li.addEventListener("dragstart", ()=>{ draggedDailyIndex=i; });
    li.addEventListener("dragover", e=>e.preventDefault());
    li.addEventListener("drop", ()=>{
      const [moved]=dailyTasksGlobal.splice(draggedDailyIndex,1);
      dailyTasksGlobal.splice(i,0,moved);
      save("dailyTasksGlobal", dailyTasksGlobal);
      const doneMoved=checklistHistory[selectedDate].dailyTasksDone.splice(draggedDailyIndex,1)[0];
      checklistHistory[selectedDate].dailyTasksDone.splice(i,0,doneMoved);
      saveHistory();
      renderDailyTasks();
    });
    dailyList.appendChild(li);
  });
}

/* ===== RENDER CUSTOM TASKS ===== */
const customList=document.getElementById("customList");
let draggedCustomIndex=null;
function renderCustomTasks(){
  ensureDateExists(selectedDate);
  const tasks=checklistHistory[selectedDate].customTasks;
  customList.innerHTML="";
  tasks.forEach((t,i)=>{
    const li=document.createElement("li");
    li.draggable=true;
    li.dataset.index=i;
    li.innerHTML=`<span><input type="checkbox" ${t.done?"checked":""}> ${t.text}</span>
                  <button>X</button>`;
    li.querySelector("input").onchange = e=>{
      checklistHistory[selectedDate].customTasks[i].done=e.target.checked;
      saveHistory();
    };
    li.querySelector("button").onclick = ()=>{
      checklistHistory[selectedDate].customTasks.splice(i,1);
      saveHistory();
      renderCustomTasks();
    };
    li.addEventListener("dragstart", ()=>{ draggedCustomIndex=i; });
    li.addEventListener("dragover", e=>e.preventDefault());
    li.addEventListener("drop", ()=>{
      const [moved]=checklistHistory[selectedDate].customTasks.splice(draggedCustomIndex,1);
      checklistHistory[selectedDate].customTasks.splice(i,0,moved);
      saveHistory();
      renderCustomTasks();
    });
    customList.appendChild(li);
  });
}

/* ===== ADD TASK VIA POPUP ===== */
document.getElementById("addTaskButton").onclick = ()=>{
  const win = window.open("", "Add Task", "width=400,height=250");
  win.document.write(`
    <p>Task Description:</p>
    <input id="taskText" type="text" style="width:90%">
    <p><input type="radio" name="taskType" id="dailyTask"> Daily Task</p>
    <p><input type="radio" name="taskType" id="dateTask"> Date-Specific Task</p>
    <p>Date: <input type="date" id="taskDate" value="${selectedDate}" disabled></p>
    <button id="submitBtn">Add Task</button>
    <script>
      const dailyRadio=document.getElementById('dailyTask');
      const dateRadio=document.getElementById('dateTask');
      const taskDate=document.getElementById('taskDate');
      dailyRadio.onchange=()=>{ if(dailyRadio.checked) taskDate.disabled=true; };
      dateRadio.onchange=()=>{ taskDate.disabled=!dateRadio.checked; };
      document.getElementById('submitBtn').onclick=()=>{
        const text=document.getElementById('taskText').value.trim();
        const dateVal=taskDate.value;
        let type=null;
        if(dailyRadio.checked) type='daily';
        else if(dateRadio.checked) type='date';
        if(!text || !type){ alert('Enter text and select task type'); return; }
        window.opener.postMessage({type,text,date:dateVal},'*');
        window.close();
      };
    <\/script>
  `);
};

/* ===== HANDLE NEW TASKS FROM POPUP ===== */
window.addEventListener("message", e=>{
  const {type,text,date}=e.data;
  if(type==="daily"){
    dailyTasksGlobal.push({text});
    save("dailyTasksGlobal", dailyTasksGlobal);
    // Update dailyTasksDone array for all dates
    for(let d in checklistHistory){
      checklistHistory[d].dailyTasksDone.push(false);
    }
    renderDailyTasks();
    saveHistory();
  } else if(type==="date"){
    ensureDateExists(date);
    checklistHistory[date].customTasks.push({text,done:false});
    if(date===selectedDate) renderCustomTasks();
    saveHistory();
  }
});

/* ===== DATE PICKER ===== */
document.getElementById("datePicker").onchange = e=>{
  selectedDate = e.target.value;
  renderDailyTasks();
  renderCustomTasks();
};

/* ===== RESET SYSTEM ===== */
const resetInput=document.getElementById("resetTime");
resetInput.value = localStorage.getItem("resetTime") || "04:00";
resetInput.onchange = ()=> localStorage.setItem("resetTime", resetInput.value);

document.getElementById("manualReset").onclick = ()=>{
  ensureDateExists(selectedDate);
  checklistHistory[selectedDate].dailyTasksDone=dailyTasksGlobal.map(()=>false);
  saveHistory();
  renderDailyTasks();
};

function checkDailyReset(){
  const time=localStorage.getItem("resetTime");
  if(!time) return;
  const now=new Date();
  const today=now.toDateString();
  if(localStorage.getItem("lastReset")===today) return;
  const [h,m]=time.split(":");
  if(now.getHours()>=h && now.getMinutes()>=m){
    ensureDateExists(selectedDate);
    checklistHistory[selectedDate].dailyTasksDone=dailyTasksGlobal.map(()=>false);
    saveHistory();
    localStorage.setItem("lastReset",today);
    renderDailyTasks();
  }
}
setInterval(checkDailyReset,30000);

/* ===== MEDIA LAYER ===== */
const mediaLayer=document.getElementById("mediaLayer");
const fileInput=document.getElementById("fileInput");
let editMode=false;
let action=null,targetIndex=null,startX,startY,startW,startH,offsetX,offsetY;

function renderMedia(){
  mediaLayer.innerHTML="";
  const media=load("media",[]);
  media.forEach((m,i)=>{
    const div=document.createElement("div");
    div.className="media"+(editMode?" edit":"");
    div.style.left=m.x+"px";
    div.style.top=m.y+"px";
    div.style.width=m.w+"px";
    div.style.height=m.h+"px";
    div.dataset.index=i;
    div.innerHTML=`<img src="${m.src}"><button class="deleteBtn">×</button><div class="resize"></div>`;
    div.querySelector(".deleteBtn").onclick=()=>{
      const arr=load("media",[]);
      arr.splice(i,1);
      save("media",arr);
      renderMedia();
    };
    mediaLayer.appendChild(div);
  });
}

mediaLayer.addEventListener("mousedown",e=>{
  if(!editMode) return;
  const mediaEl=e.target.closest(".media");
  if(!mediaEl) return;
  const index=Number(mediaEl.dataset.index);
  const rect=mediaEl.getBoundingClientRect();
  targetIndex=index;
  if(e.target.classList.contains("resize")){
    action="resize";
    startX=e.clientX; startY=e.clientY;
    startW=rect.width; startH=rect.height;
  } else {
    action="drag";
    offsetX=e.clientX-rect.left;
    offsetY=e.clientY-rect.top;
  }
});
window.addEventListener("mousemove",e=>{
  if(!action) return;
  const media=load("media",[]);
  const item=media[targetIndex];
  if(action==="drag"){ item.x=e.clientX-offsetX; item.y=e.clientY-offsetY; }
  if(action==="resize"){ item.w=Math.max(50,startW+(e.clientX-startX)); item.h=Math.max(50,startH+(e.clientY-startY)); }
  save("media",media);
  renderMedia();
});
window.addEventListener("mouseup",()=>{ action=null; });

document.getElementById("addMedia").onclick=()=>fileInput.click();
fileInput.onchange=e=>{
  const files=[...e.target.files]; if(!files.length) return;
  const media=load("media",[]);
  const offset=media.length;
  files.forEach((file,i)=>{
    const reader=new FileReader();
    reader.onload=ev=>{
      media.push({src:ev.target.result,x:120+(offset+i)*20,y:120+(offset+i)*20,w:200,h:200});
      if(i===files.length-1){ save("media",media); renderMedia(); }
    };
    reader.readAsDataURL(file);
  });
  fileInput.value="";
};
document.getElementById("toggleEdit").onclick=()=>{ editMode=!editMode; renderMedia(); };

/* ===== INIT ===== */
ensureDateExists(selectedDate);
renderDailyTasks();
renderCustomTasks();
renderMedia();
checkDailyReset();
</script>
</body>
</html>
