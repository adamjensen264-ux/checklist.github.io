<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checklist with Editable Media</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; height:100vh; background:#111; color:white; display:flex; justify-content:center; align-items:flex-start; overflow:hidden;}
#mediaCanvas { position:fixed; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events:none; }
.media-item { position:absolute; cursor:move; z-index:1; display:flex; justify-content:center; align-items:center; }
.media-item img { display:block; width:100%; height:100%; object-fit:contain; pointer-events:none; }
.media-item .deleteBtn { position:absolute; top:0; right:0; background:red; color:white; border:none; font-size:12px; padding:2px 4px; cursor:pointer; display:none; z-index:5; }
.container { background:#1c1c1ccc; padding:25px; border-radius:12px; width:380px; margin-top:30px; box-shadow:0 0 20px rgba(0,0,0,0.5); z-index:2; position:relative; }
.task { display:flex; justify-content:space-between; align-items:center; margin:8px 0; padding:5px 8px; border-radius:6px; background:#222; cursor: grab; }
.task.dragging { opacity:0.5; }
button { background:#333; border:none; color:white; padding:6px 10px; border-radius:6px; cursor:pointer; }
button:hover { background:#555; }
input[type="text"], input[type="time"] { width:70%; padding:6px; }
.controls { margin-top:10px; display:flex; gap:8px; }
.small { font-size:13px; color:#aaa; text-align:center; margin-top:10px; }
#addMediaBtn { width:60px; height:60px; border:2px dashed #fff; border-radius:8px; display:flex; justify-content:center; align-items:center; font-size:24px; cursor:pointer; color:#fff; user-select:none; position:fixed; bottom:10px; left:50%; transform:translateX(-50%); z-index:3; }
</style>
</head>
<body>

<div id="mediaCanvas"></div>

<div class="container">
<h1>Daily Checklist</h1>
<div id="taskList"></div>

<div class="controls">
    <input id="newTask" type="text" placeholder="New task...">
    <button onclick="addTask()">Add</button>
</div>

<hr>

<div>
    Reset Time:
    <input type="time" id="resetTime">
</div>

<div class="controls">
    <button onclick="manualReset()">Reset Now</button>
    <button id="editModeBtn">Enter Edit Mode</button>
</div>

<div class="small" id="info"></div>
</div>

<div id="addMediaBtn">+</div>
<input type="file" id="mediaInput" accept="image/*,image/gif" style="display:none" multiple>

<script>
/* STORAGE KEYS */
const TASK_KEY="tasks", RESET_TIME_KEY="resetTime", LAST_RESET_KEY="lastReset", MEDIA_KEY="mediaFiles";

/* TASKS */
function getTasks(){return JSON.parse(localStorage.getItem(TASK_KEY))||[];}
function saveTasks(tasks){localStorage.setItem(TASK_KEY, JSON.stringify(tasks));}

/* RENDER TASKS */
const taskListEl=document.getElementById("taskList");
let dragSrcIndex=null;
function render(){ renderTasks(); renderMedia(); updateInfo(); }

function renderTasks(){
    taskListEl.innerHTML="";
    const tasks=getTasks();
    tasks.forEach((task,index)=>{
        const div=document.createElement("div"); div.className="task"; div.draggable=true;
        const label=document.createElement("label");
        const checkbox=document.createElement("input"); checkbox.type="checkbox"; checkbox.checked=task.checked;
        checkbox.onchange=()=>{tasks[index].checked=checkbox.checked; saveTasks(tasks);}
        label.appendChild(checkbox); label.append(" "+task.text);
        const delBtn=document.createElement("button"); delBtn.textContent="✕";
        delBtn.onclick=()=>{ tasks.splice(index,1); saveTasks(tasks); render(); }
        div.appendChild(label); div.appendChild(delBtn); taskListEl.appendChild(div);

        div.addEventListener("dragstart",(e)=>{ dragSrcIndex=index; div.classList.add("dragging"); });
        div.addEventListener("dragend",()=>{ div.classList.remove("dragging"); });
        div.addEventListener("dragover",(e)=>{ e.preventDefault(); });
        div.addEventListener("drop",(e)=>{ 
            e.preventDefault();
            if(dragSrcIndex===null || dragSrcIndex===index) return;
            const moved=tasks.splice(dragSrcIndex,1)[0];
            tasks.splice(index,0,moved);
            saveTasks(tasks);
            render();
        });
    });
}

function addTask(){ const t=document.getElementById("newTask").value.trim(); if(!t) return; const tasks=getTasks(); tasks.push({text:t,checked:false}); saveTasks(tasks); document.getElementById("newTask").value=""; render(); }
function manualReset(){ const tasks=getTasks(); tasks.forEach(t=>t.checked=false); saveTasks(tasks); localStorage.setItem(LAST_RESET_KEY, Date.now()); render(); }
function getResetMinutes(){ const v=localStorage.getItem(RESET_TIME_KEY)||"04:00"; const [h,m]=v.split(":").map(Number); return h*60+m; }
function checkDailyReset(){ const last=Number(localStorage.getItem(LAST_RESET_KEY)||0); const now=new Date(); const minutesNow=now.getHours()*60+now.getMinutes(); const resetM=getResetMinutes(); const resetDate=new Date(); resetDate.setHours(0,0,0,0); resetDate.setMinutes(resetM); if(minutesNow<resetM) resetDate.setDate(resetDate.getDate()-1); if(last<resetDate.getTime()){ manualReset(); localStorage.setItem(LAST_RESET_KEY,resetDate.getTime()); } }
const resetInput=document.getElementById("resetTime");
function loadResetTime(){ resetInput.value=localStorage.getItem(RESET_TIME_KEY)||"04:00"; }
resetInput.addEventListener("change",()=>{ localStorage.setItem(RESET_TIME_KEY,resetInput.value); updateInfo(); });
function updateInfo(){ document.getElementById("info").textContent=`Checklist resets daily at ${localStorage.getItem(RESET_TIME_KEY)||"04:00"}`; }

/* MEDIA */
const bgCanvas=document.getElementById("mediaCanvas");
const mediaInput=document.getElementById("mediaInput");
const addMediaBtn=document.getElementById("addMediaBtn");
const editModeBtn=document.getElementById("editModeBtn");
let editMode=false;
function getMedia(){return JSON.parse(localStorage.getItem(MEDIA_KEY))||[];}
function saveMedia(m){localStorage.setItem(MEDIA_KEY,JSON.stringify(m));}

function renderMedia(){
    bgCanvas.innerHTML="";
    const media=getMedia();
    media.forEach((item,index)=>{
        const div=document.createElement("div");
        div.className="media-item"; div.style.left=item.x+"px"; div.style.top=item.y+"px"; div.style.width=item.width+"px"; div.style.height=item.height+"px";
        const img=document.createElement("img"); img.src=item.src; div.appendChild(img);

        const delBtn=document.createElement("button"); delBtn.textContent="✕"; delBtn.className="deleteBtn";
        delBtn.onclick=()=>{ const m=getMedia(); m.splice(index,1); saveMedia(m); render(); };
        if(editMode) delBtn.style.display="block";
        div.appendChild(delBtn);

        bgCanvas.appendChild(div);
        if(editMode){ div.style.pointerEvents="auto"; div.style.border="2px dashed #fff"; makeDraggableResizable(div,index); } 
        else{ div.style.pointerEvents="none"; div.style.border="none"; }
    });
}

/* ADD MEDIA FIXED */
addMediaBtn.addEventListener("click",()=>{
    mediaInput.value=""; // reset before opening dialog
    mediaInput.click();
});

mediaInput.addEventListener("change",(e)=>{
    const files=Array.from(e.target.files);
    const media=getMedia();
    let remaining=files.length;

    files.forEach(file=>{
        const reader=new FileReader();
        reader.onload=(ev)=>{
            media.push({src:ev.target.result,x:50,y:50,width:150,height:150});
            remaining--;
            if(remaining===0){ saveMedia(media); render(); }
        };
        reader.readAsDataURL(file);
    });
});

/* EDIT MODE */
editModeBtn.addEventListener("click",()=>{
    editMode=!editMode;
    editModeBtn.textContent=editMode?"Exit Edit Mode":"Enter Edit Mode";
    render();
});

/* DRAG/RESIZE */
function makeDraggableResizable(el,index){
    let dragging=false,resizing=false,startX,startY,startW,startH;
    el.addEventListener("mousedown",(e)=>{
        if(e.offsetX>el.clientWidth-10 && e.offsetY>el.clientHeight-10){ resizing=true; startW=el.offsetWidth; startH=el.offsetHeight; }
        else dragging=true;
        startX=e.clientX; startY=e.clientY; e.preventDefault();
    });
    window.addEventListener("mousemove",(e)=>{
        if(!dragging && !resizing) return;
        const media=getMedia();
        if(dragging){ const dx=e.clientX-startX; const dy=e.clientY-startY; el.style.left=media[index].x+dx+"px"; el.style.top=media[index].y+dy+"px"; }
        if(resizing){ const dx=e.clientX-startX; const dy=e.clientY-startY; el.style.width=startW+dx+"px"; el.style.height=startH+dy+"px"; }
    });
    window.addEventListener("mouseup",(e)=>{
        const media=getMedia();
        if(dragging){ media[index].x=parseInt(el.style.left); media[index].y=parseInt(el.style.top); saveMedia(media); }
        if(resizing){ media[index].width=parseInt(el.style.width); media[index].height=parseInt(el.style.height); saveMedia(media); }
        dragging=false; resizing=false;
    });
}

/* INIT */
loadResetTime(); checkDailyReset(); render();
</script>
</body>
</html>
