<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Daily Checklist</title>

<style>
body{
  font-family:Arial;
  background:#111;
  color:white;
  text-align:center;
  margin:0;
}

.container{
  position:relative;
  z-index:2;
  max-width:600px;
  margin:auto;
  padding:20px;
  background:#1e1e1e;
  border-radius:10px;
}

ul{list-style:none;padding:0}
li{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#2a2a2a;
  margin:6px 0;
  padding:8px;
  border-radius:6px;
  cursor:grab;
}

button{
  padding:6px 10px;
  margin:5px;
  border:none;
  border-radius:6px;
  background:#6b5cff;
  color:white;
  cursor:pointer;
}

input[type=text]{
  padding:6px;
  width:70%;
}

/* MEDIA AREA */
#mediaLayer{
  position:fixed;
  inset:0;
  z-index:1;
  pointer-events:none;
}

.mediaItem{
  position:absolute;
  pointer-events:auto;
}

.mediaItem img{
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:8px;
}

.deleteMedia{
  position:absolute;
  top:-10px;
  right:-10px;
  background:red;
  border-radius:50%;
  width:22px;
  height:22px;
  display:none;
  font-size:14px;
}

.resizeHandle{
  width:14px;
  height:14px;
  background:white;
  position:absolute;
  right:0;
  bottom:0;
  cursor:nwse-resize;
  display:none;
}

.editing .deleteMedia,
.editing .resizeHandle{
  display:block;
}
</style>
</head>

<body>

<div id="mediaLayer"></div>

<div class="container">
<h2>Daily Checklist</h2>

<input id="taskInput" placeholder="New task">
<button id="addTaskBtn">Add Task</button>

<ul id="taskList"></ul>

<div>
Reset Time:
<input type="time" id="resetTime">
<button id="resetBtn">Manual Reset</button>
</div>

<hr>

<button id="editMediaBtn">Edit Media</button>
<button id="addMediaBtn">+ Media</button>
<input type="file" id="mediaInput" accept="image/*,image/gif" multiple hidden>

</div>

<script>
/* ================= STORAGE ================= */

const getTasks=()=>JSON.parse(localStorage.getItem("tasks")||"[]");
const saveTasks=t=>localStorage.setItem("tasks",JSON.stringify(t));

const getMedia=()=>JSON.parse(localStorage.getItem("media")||"[]");
const saveMedia=m=>localStorage.setItem("media",JSON.stringify(m));

/* ================= TASKS ================= */

const list=document.getElementById("taskList");

function renderTasks(){
  list.innerHTML="";
  const tasks=getTasks();

  tasks.forEach((t,i)=>{
    const li=document.createElement("li");
    li.draggable=true;
    li.dataset.index=i;

    li.innerHTML=`
      <span>
        <input type="checkbox" ${t.done?"checked":""}>
        ${t.text}
      </span>
      <button class="deleteTask">X</button>
    `;
    list.appendChild(li);
  });
}

document.getElementById("addTaskBtn").onclick=()=>{
  const input=document.getElementById("taskInput");
  if(!input.value.trim()) return;
  const tasks=getTasks();
  tasks.push({text:input.value,done:false});
  saveTasks(tasks);
  input.value="";
  renderTasks();
};

list.addEventListener("click",e=>{
  const li=e.target.closest("li");
  if(!li) return;
  const idx=li.dataset.index;
  const tasks=getTasks();

  if(e.target.type==="checkbox"){
    tasks[idx].done=e.target.checked;
  }

  if(e.target.classList.contains("deleteTask")){
    tasks.splice(idx,1);
  }

  saveTasks(tasks);
  renderTasks();
});

/* DRAG SORT */
let dragIndex=null;

list.addEventListener("dragstart",e=>{
  dragIndex=e.target.dataset.index;
});

list.addEventListener("dragover",e=>e.preventDefault());

list.addEventListener("drop",e=>{
  const target=e.target.closest("li");
  if(!target) return;

  const tasks=getTasks();
  const moved=tasks.splice(dragIndex,1)[0];
  tasks.splice(target.dataset.index,0,moved);

  saveTasks(tasks);
  renderTasks();
});

/* ================= RESET ================= */

document.getElementById("resetBtn").onclick=()=>{
  const tasks=getTasks().map(t=>({...t,done:false}));
  saveTasks(tasks);
  renderTasks();
};

const resetInput=document.getElementById("resetTime");
resetInput.value=localStorage.getItem("resetTime")||"04:00";

resetInput.onchange=()=>{
  localStorage.setItem("resetTime",resetInput.value);
};

function checkDailyReset(){
  const time=localStorage.getItem("resetTime");
  if(!time) return;

  const now=new Date();
  const today=now.toDateString();

  if(localStorage.getItem("lastReset")===today) return;

  const [h,m]=time.split(":");
  if(now.getHours()>=h && now.getMinutes()>=m){
    const tasks=getTasks().map(t=>({...t,done:false}));
    saveTasks(tasks);
    localStorage.setItem("lastReset",today);
    renderTasks();
  }
}

setInterval(checkDailyReset,30000);

/* ================= MEDIA ================= */

const mediaLayer=document.getElementById("mediaLayer");
const fileInput=document.getElementById("mediaInput");
let editMode=false;

function renderMedia(){
  mediaLayer.innerHTML="";
  const media=getMedia();

  media.forEach((m,i)=>{
    const div=document.createElement("div");
    div.className="mediaItem";
    if(editMode) div.classList.add("editing");

    div.style.left=m.x+"px";
    div.style.top=m.y+"px";
    div.style.width=m.w+"px";
    div.style.height=m.h+"px";

    div.innerHTML=`
      <img src="${m.src}">
      <button class="deleteMedia">Ã—</button>
      <div class="resizeHandle"></div>
    `;

    /* delete */
    div.querySelector(".deleteMedia").onclick=()=>{
      const arr=getMedia();
      arr.splice(i,1);
      saveMedia(arr);
      renderMedia();
    };

    /* drag move */
    let moving=false,ox,oy;

    div.onmousedown=e=>{
      if(!editMode || e.target.className==="resizeHandle") return;
      moving=true;
      ox=e.clientX-div.offsetLeft;
      oy=e.clientY-div.offsetTop;
    };

    document.onmousemove=e=>{
      if(!moving) return;
      div.style.left=e.clientX-ox+"px";
      div.style.top=e.clientY-oy+"px";
    };

    document.onmouseup=()=>{
      if(!moving) return;
      moving=false;
      const arr=getMedia();
      arr[i].x=div.offsetLeft;
      arr[i].y=div.offsetTop;
      saveMedia(arr);
    };

    /* resize */
    const handle=div.querySelector(".resizeHandle");
    let resizing=false,sx,sy,sw,sh;

    handle.onmousedown=e=>{
      e.stopPropagation();
      resizing=true;
      sx=e.clientX;
      sy=e.clientY;
      sw=div.offsetWidth;
      sh=div.offsetHeight;
    };

    document.onmousemove=e=>{
      if(!resizing) return;
      div.style.width=sw+(e.clientX-sx)+"px";
      div.style.height=sh+(e.clientY-sy)+"px";
    };

    document.onmouseup=()=>{
      if(!resizing) return;
      resizing=false;
      const arr=getMedia();
      arr[i].w=div.offsetWidth;
      arr[i].h=div.offsetHeight;
      saveMedia(arr);
    };

    mediaLayer.appendChild(div);
  });
}

/* ADD MEDIA (FIXED MULTI-UPLOAD) */
document.getElementById("addMediaBtn").onclick=()=>{
  fileInput.click();
};

fileInput.addEventListener("change",e=>{
  const files=[...e.target.files];
  if(!files.length) return;

  const media=getMedia();
  let loaded=0;

  files.forEach(file=>{
    const reader=new FileReader();
    reader.onload=ev=>{
      media.push({
        src:ev.target.result,
        x:100+loaded*20,
        y:100+loaded*20,
        w:200,
        h:200
      });

      loaded++;
      if(loaded===files.length){
        saveMedia(media);
        renderMedia();
      }
    };
    reader.readAsDataURL(file);
  });

  /* CRITICAL FIX */
  fileInput.value="";
});

/* EDIT MODE */
document.getElementById("editMediaBtn").onclick=()=>{
  editMode=!editMode;
  renderMedia();
};

/* ================= INIT ================= */

renderTasks();
renderMedia();
checkDailyReset();
</script>

</body>
</html>
